<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html 
 PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title>Signalbox</title>
    <style type="text/css">
      form.signalheadcontrol { border-style: solid;
			       padding: 1em; }
    </style>
    <script type="text/javascript">
      function SetSignal(id) {
	  console.log(id);

	  var responseId = "response"+id;
	  
	  var flashId = "flashing"+id;
	  var flashing = document.getElementById(flashId);
	  var flash = "Steady";
	  if( flashing.checked ) {
	      flash = "Flashing";
	  }
	  console.log(flash);

	  var aspectId = "aspect"+id;
	  var query = "input[name = '" + aspectId + "']:checked";
	  var aspect = document.querySelector(query).value;
	  console.log(aspect);

	  var xhr = new XMLHttpRequest();
          xhr.open("post", '/rpc');
          // Required by JSON-RPC over HTTP
          xhr.setRequestHeader("Content-Type","application/json");
	  
          // It is better to use real formatter like JSON.js
          var request = '{ ';
	  request += '"method": "setsignalhead", ';
	  request += '"params": [ "' + id + '", "' + aspect +'", "' + flash +'"]';
	  request += ', "id": 1 }';
	  console.log(request);

	  xhr.onreadystatechange = function() {
              if (xhr.readyState === 4) {
                  var res;
                  if(xhr.status === 200) {
		      console.log("Response = " + xhr.responseText);
                      var result = JSON.parse(xhr.responseText);
		      console.log("Result = " + result.result);
		      console.log("Error = " + result.error);
                      if(result.error==null) {
                          res = JSON.stringify(result.result);
                      }
                      else {
                          res = result.error;
                      }
                  }
                  else {
                      res = 'Invalid Status ' + xhr.status;
                  }
                  document.getElementById(responseId).innerHTML = res;
              }
          }
          xhr.send(request); 
	  
	  return false;
      }

      function AspectRadio(parent, id, value, displayedAspect) {
	  var button = document.createElement("input");
	  var label = document.createElement("label");

	  var idString = value+id;
	  button.setAttribute("type", "radio");
	  button.setAttribute("name", "aspect"+id);
	  button.setAttribute("value", value);
	  button.setAttribute("id", idString);
	  if( value==displayedAspect ) {
	      button.setAttribute("checked", "checked");
	  }

	  label.setAttribute("for",idString);
	  label.innerHTML=value;
	  
	  parent.appendChild(button);
	  parent.appendChild(label);
      }

      function FlashCheckbox(parent, id, flash) {
	  var checkbox = document.createElement("input");
	  var label = document.createElement("label");

	  var idString = "flashing"+id;
	  checkbox.setAttribute("type", "checkbox");
	  checkbox.setAttribute("name", "flash");
	  checkbox.setAttribute("id", idString);
	  if( flash=="Flashing" ) {
	      checkbox.setAttribute("checked", "checked");
	  }

	  label.setAttribute("for",idString);
	  label.innerHTML="Flashing";
	  
	  parent.appendChild(checkbox);
	  parent.appendChild(label);
      }
      
      function RenderSignalHeadForm(sh) {
	  console.log("Starting RenderSignalHead for "+JSON.stringify(sh));

	  // Create the form
	  f = document.createElement("form");
	  f.setAttribute("id", "ID"+sh.id);
	  f.setAttribute("class", "signalheadcontrol");
	  f.setAttribute("action", "");
	  f.setAttribute("onsubmit", "return SetSignal('"+sh.id+"');");

	  // Title
	  var h = document.createElement("h1");
	  h.innerHTML = "SignalHead "+sh.id;
	  f.appendChild(h);

	  // The radio buttons for the aspects
	  var aspectPara = document.createElement("p");
	  AspectRadio(aspectPara, sh.id, "Red", sh.aspect);
	  if( sh.aspectCount >= 3 ) {
	      AspectRadio(aspectPara, sh.id, "Yellow", sh.aspect);
	  }
	  if( sh.aspectCount == 4 ) {
	      AspectRadio(aspectPara, sh.id, "DoubleYellow", sh.aspect);
	  }
	  AspectRadio(aspectPara, sh.id, "Green", sh.aspect);
	  f.appendChild(aspectPara);

	  // The checkbox for Flash
	  var flashPara = document.createElement("p");
	  FlashCheckbox(flashPara, sh.id, sh.flash);
	  f.appendChild(flashPara);

	  // The submit button
	  var submitPara = document.createElement("p");
	  var button = document.createElement("input");
	  button.setAttribute("type", "submit");
	  button.setAttribute("value", "Submit");
	  submitPara.appendChild(button);
	  f.appendChild(submitPara);

	  // And the error line
	  var errorPara = document.createElement("p");
	  errorPara.setAttribute("id", "response"+sh.id);
	  f.appendChild(errorPara);

	  // Insert into document
	  document.getElementsByTagName('body')[0].appendChild(f);
      }
      
      function HandleSignalHead(id) {
	  console.log("Starting HandleSignalHead for "+id);

	  var xhr = new XMLHttpRequest();
          xhr.open("post", '/rpc');
          // Required by JSON-RPC over HTTP
          xhr.setRequestHeader("Content-Type","application/json");

	  var request = new Object();
	  request['method'] = "getsignalhead";
	  request['params'] = [ id ];
	  request['id'] = 1;
	  console.log("HandleSignalHead: Request="+JSON.stringify(request));

	  xhr.onreadystatechange = function() {
              if (xhr.readyState === 4) {
                  var res;
                  if(xhr.status === 200) {
		      console.log("HandleSignalHead: Response = " + xhr.responseText);
                      var result = JSON.parse(xhr.responseText);
		      console.log("HandleSignalHead: Result = " + JSON.stringify(result.result));
		      console.log("HandleSignalHead: Error = " + result.error);
                      if(result.error==null) {
                          RenderSignalHeadForm(result.result);
                      }
                      else {
                          document.getElementById(pageErrorLoc).innerHTML = result.error;
                      }
                  }
                  else {
                      document.getElementById(pageErrorLoc).innerHTML = 'Invalid Status ' + xhr.status;
                  }
              }
          }
          xhr.send(JSON.stringify(request));
      }
      
      function HandleItem(item) {
	  console.log("Starting HandleItem for "+JSON.stringify(item));
	  switch(item.type) {
	  case "signalhead":
	      HandleSignalHead(item.id);
	      break;
	      
	  default:
	      console.log("Unrecognised type: "+item.type);
	  }
      }
      
      function HandleItemList(items) {
	  console.log("Starting HandleItemList");

	  for( var i=0; i<items.length; i++ ) {
	      HandleItem(items[i]);
	  }
      }
      
      function LoadInfo() {
	  console.log("Starting LoadInfo");
	  
	  var xhr = new XMLHttpRequest();
          xhr.open("post", '/rpc');
          // Required by JSON-RPC over HTTP
          xhr.setRequestHeader("Content-Type","application/json");
	  
          // It is better to use real formatter like JSON.js
          var request = new Object();
	  request['method'] = "listitems";
	  request['params'] = [];
	  request['id'] = 1;
	  console.log(JSON.stringify(request));

	  var pageErrorLoc = "pageErrorMessage";
	  xhr.onreadystatechange = function() {
              if (xhr.readyState === 4) {
                  var res;
                  if(xhr.status === 200) {
		      console.log("Response = " + xhr.responseText);
                      var result = JSON.parse(xhr.responseText);
		      console.log("Result = " + JSON.stringify(result.result));
		      console.log("Error = " + result.error);
                      if(result.error==null) {
                          HandleItemList(result.result);
                      }
                      else {
                          document.getElementById(pageErrorLoc).innerHTML = result.error;
                      }
                  }
                  else {
                      document.getElementById(pageErrorLoc).innerHTML = 'Invalid Status ' + xhr.status;
                  }
              }
          }
          xhr.send(JSON.stringify(request));
	  
	  console.log("Completed LoadInfo");
      }
    </script>
  </head>
  <body onload=LoadInfo()>
    <form id="ID00:00:00:01"
	  class="signalheadcontrol"
	  action=""
	  onsubmit="return SetSignal('00:00:00:01');" >
      <h1>SignalHead 00:00:00:01</h1>
      <p>
	<input type="radio" name="aspect00:00:00:01"
	       value="Red"
	       id="red00:00:00:01" 
	       checked="checked" />
	<label for="red00:00:00:01">Red</label>
	<input type="radio" name="aspect00:00:00:01"
	       value="Yellow"
	       id="yellow00:00:00:01" />
	<label for="yellow00:00:00:01">Yellow</label>
	<input type="radio" name="aspect00:00:00:01"
	       value="DoubleYellow"
	       id="doubleyellow00:00:00:01" />
	<label for="doubleyellow00:00:00:01">Double Yellow</label>
	<input type="radio" name="aspect00:00:00:01"
	       value="Green"
	       id="green00:00:00:01" />
	<label for="green00:00:00:01">Green</label>
      </p>
      <p>
	<input type="checkbox" name="flash"
	       value="flashing"
	       id="flashing00:00:00:01" />
	<label for="flashing00:00:00:01">Flashing</label>
      </p>
      <p>
	<input type="submit" value="Submit" />
      </p>
      <p id="response00:00:00:01" />
    </form>

    <p id="pageErrorMessage" />
  </body>
</html>
